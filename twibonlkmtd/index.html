<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" name="viewport" />
    <title>Twibbon Generator | BEM FST & FIK</title>
    <link rel="icon" type="image/png" href="/assets/images/KABINET.png.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <link rel="stylesheet" href="/assets/css/main.css" />

    <style>
      .canvas-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        aspect-ratio: 1 / 1;
        background-color: #e5e7eb;
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
        border: 2px dashed #900bb7;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);

        /* PENTING: Mencegah scroll layar saat geser foto di HP */
        touch-action: none;
      }

      .canvas-container {
        margin: 0 auto !important;
      }
      #twibbonCanvas {
        display: block;
        width: 100%;
        height: 100%;
      }
      input[type="range"] {
        accent-color: #900bb7;
      }
    </style>
  </head>

  <body class="bg-gray-50 font-inter">
    <div id="navbar"></div>

    <main class="flex-grow max-w-7xl mx-auto px-6 pb-16">
      <nav aria-label="breadcrumb" class="bg-white rounded-xl shadow-md max-w-3xl mx-auto mt-6">
        <ol class="flex items-center gap-1 text-gray-700 font-semibold text-lg rounded-xl px-6 py-4">
          <a href="/"><li>Beranda</li></a>
          <li class="text-[#5A007A]">â€º</li>
          <li class="text-[#5A007A]">Twibon</li>
          <li><span class="text-[#C26CFF]"> â€º LKMTD </span></li>
        </ol>
      </nav>

      <section class="max-w-5xl mt-10 mx-auto">
        <div class="flex justify-end mb-6">
          <div class="w-[320px] text-center py-1 rounded-l-md text-white font-bold text-lg shadow-md" style="background: linear-gradient(to left, #c26cff00, #d05af4, #900bb7, #c26cff00)">Twibon LKMTD 2026</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-purple-100">
          <div class="order-2 md:order-1 flex flex-col items-center">
            <div class="canvas-wrapper" id="canvasWrapper">
              <canvas id="twibbonCanvas"></canvas>
            </div>

            <div class="mt-4 flex items-center gap-2 text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full animate-pulse">
              <i class="fas fa-arrows-alt text-[#900BB7]"></i>
              <span>Klik & Geser di mana saja</span>
            </div>
          </div>

          <div class="order-1 md:order-2 space-y-6">
            <div class="text-center md:text-left">
              <h2 class="text-3xl font-bold text-[#5A007A]">Generator Twibbon</h2>
              <p class="text-gray-600 mt-2">Dukung acara LKMTD 2026. Upload fotomu sekarang!</p>
            </div>

            <div class="bg-purple-50 p-5 rounded-2xl border border-purple-100 shadow-sm hover:shadow-md transition-shadow">
              <label class="block text-sm font-bold text-gray-800 mb-3"> <i class="fas fa-camera text-purple-600 mr-2"></i> 1. Pilih Foto Kamu </label>
              <input
                type="file"
                id="uploadImg"
                accept="image/*"
                class="block w-full text-sm text-purple-700 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-[#900BB7] file:text-white hover:file:bg-[#7a0899] cursor-pointer bg-white rounded-lg border border-purple-200"
              />
            </div>

            <div id="controlsArea" class="hidden space-y-5 opacity-0 transition-opacity duration-500">
              <div class="bg-purple-50 p-5 rounded-2xl border border-purple-100">
                <label class="block text-sm font-bold text-gray-800 mb-3"> <i class="fas fa-expand text-purple-600 mr-2"></i> 2. Zoom Foto </label>
                <input type="range" id="scaleSlider" min="0.1" max="3" step="0.05" value="1" class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer" />
              </div>

              <button id="downloadBtn" class="w-full bg-[#900BB7] hover:bg-[#6A008C] text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-all transform hover:-translate-y-1 flex items-center justify-center gap-2 text-lg">
                <i class="fas fa-download"></i> Simpan Gambar
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="max-w-5xl mx-auto mt-12 px-2">
        <div class="rounded-3xl border border-purple-100 bg-white p-6 md:p-8 shadow-lg">
          <div class="flex items-start gap-4">
            <div class="w-14 h-14 rounded-2xl bg-[#900BB7]/10 flex items-center justify-center shrink-0">
              <i class="fas fa-bullhorn text-[#900BB7] text-2xl"></i>
            </div>

            <div class="flex-1">
              <h2 class="text-2xl md:text-3xl font-extrabold text-[#5A007A]">Ayo Ikut Kampanye LKMTD 2026!</h2>
              <p class="mt-2 text-gray-700 leading-relaxed">Upload foto, atur posisinya, simpan, lalu bagikan ke Instagram Story / WhatsApp. Pakai caption berikut supaya kampanye makin luas ðŸŒŸ</p>
            </div>
          </div>

          <div class="mt-6 rounded-2xl border border-purple-100 bg-purple-50 p-5">
            <p class="text-sm font-bold text-gray-800 mb-2">Contoh Caption Kampanye:</p>

            <p class="text-gray-800 leading-relaxed">
              Saya <span class="font-bold text-[#5A007A]">[Nama]</span>, siap mengikuti <span class="font-bold">LKMTD 2026</span> bersama <span class="font-bold">BEM FST & FIK</span>. <br />Saatnya bertumbuh, berdaya, dan berkontribusi
              untuk perubahan yang lebih baik!
            </p>

            <p class="mt-3 font-semibold text-[#5A007A]">#LKMTD2026 #BEMFSTFIK #UNUGIRI</p>
          </div>

          <p class="mt-4 text-sm text-gray-500">ðŸ“Œ Jangan lupa tag akun <span class="font-semibold text-[#5A007A]">@bemfstfikunugiri</span> saat membagikan Twibbon.</p>
        </div>
      </section>
    </main>

    <div class="fixed bottom-6 left-6 z-50">
      <button id="layanan110Btn" class="bg-[#900BB7] hover:bg-[#6A008C] text-white font-bold py-3 px-5 rounded-full shadow-lg flex items-center gap-2"><i class="fas fa-bullhorn"></i> Aspirasi</button>
    </div>

    <div id="layanan110Modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h2 class="text-xl font-bold mb-4 text-[#900BB7]">Layanan Aspirasi</h2>
        <div class="flex justify-end gap-3">
          <button id="closeModalBtn" class="bg-gray-100 text-gray-700 py-2 px-5 rounded-lg">Tutup</button>
        </div>
      </div>
    </div>

    <script>
      const CONFIG = {
        canvasSize: 1080,
        twibbonUrl: "/assets/images/twibon_LKMTD.png",
      };

      const canvas = new fabric.Canvas("twibbonCanvas", {
        width: CONFIG.canvasSize,
        height: CONFIG.canvasSize,
        backgroundColor: "#ffffff",
        preserveObjectStacking: true,
        selection: false, // Kita handle manual
        stopContextMenu: true,
      });
      canvas.enableRetinaScaling = false;

      let userImgNode = null;
      let frameImgNode = null;
      let currentZoom = 1;

      // Variabel untuk Custom Drag Logic
      let isDragging = false;
      let lastPosX = 0;
      let lastPosY = 0;

      // --- LAYERING ---
      function ensureLayerOrder() {
        // Pastikan Frame selalu di Index Tertinggi (Depan)
        if (userImgNode) userImgNode.moveTo(0);
        if (frameImgNode) frameImgNode.bringToFront();
        canvas.requestRenderAll();
      }

      // --- RESPONSIF ---
      function resizeCanvas() {
        const wrapper = document.getElementById("canvasWrapper");
        const size = Math.max(1, Math.floor(wrapper.getBoundingClientRect().width));
        currentZoom = size / CONFIG.canvasSize;
        canvas.setDimensions({ width: size, height: size }, { cssOnly: true });
        canvas.setViewportTransform([currentZoom, 0, 0, currentZoom, 0, 0]);
        canvas.requestRenderAll();
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // --- LOAD FRAME ---
      function loadTwibbonFrame() {
        fabric.Image.fromURL(
          CONFIG.twibbonUrl,
          (img) => {
            if (!img) return;
            if (frameImgNode) canvas.remove(frameImgNode);

            img.set({
              left: 0,
              top: 0,
              scaleX: CONFIG.canvasSize / img.width,
              scaleY: CONFIG.canvasSize / img.height,
              selectable: false, // Tidak bisa dipilih via Fabric
              evented: false, // Tembus klik
              opacity: 1,
            });

            frameImgNode = img;
            canvas.add(frameImgNode);
            ensureLayerOrder();
          },
          { crossOrigin: "anonymous" }
        );
      }
      loadTwibbonFrame();

      // --- CUSTOM DRAG LOGIC (The Magic Part) ---
      // Kita pakai event Canvas langsung, bukan Object

      canvas.on("mouse:down", function (opt) {
        // Hanya mulai drag jika foto user sudah ada
        if (!userImgNode) return;

        const evt = opt.e;
        isDragging = true;

        // Ambil posisi mouse/touch awal
        if (evt.type === "touchstart") {
          lastPosX = evt.touches[0].clientX;
          lastPosY = evt.touches[0].clientY;
        } else {
          lastPosX = evt.clientX;
          lastPosY = evt.clientY;
        }

        // EFEK VISUAL: Frame jadi transparan
        if (frameImgNode) {
          frameImgNode.set("opacity", 0.5); // Samar 0.5
        }

        canvas.requestRenderAll();
      });

      canvas.on("mouse:move", function (opt) {
        if (!isDragging || !userImgNode) return;

        const evt = opt.e;
        let currX, currY;

        if (evt.type === "touchmove") {
          currX = evt.touches[0].clientX;
          currY = evt.touches[0].clientY;
        } else {
          currX = evt.clientX;
          currY = evt.clientY;
        }

        // Hitung selisih gerakan mouse (Delta)
        // Kita bagi dengan currentZoom agar gerakan 1:1 mengikuti jari di layar HP
        const deltaX = (currX - lastPosX) / currentZoom;
        const deltaY = (currY - lastPosY) / currentZoom;

        // Pindahkan Foto
        userImgNode.left += deltaX;
        userImgNode.top += deltaY;
        userImgNode.setCoords(); // Update koordinat internal

        // Simpan posisi terakhir
        lastPosX = currX;
        lastPosY = currY;

        canvas.requestRenderAll();
      });

      canvas.on("mouse:up", function () {
        isDragging = false;

        // EFEK VISUAL: Balikkan Frame jadi Normal
        if (frameImgNode) {
          frameImgNode.set("opacity", 1); // Full terlihat
        }

        canvas.requestRenderAll();
      });

      // --- UPLOAD FOTO ---
      const uploadInput = document.getElementById("uploadImg");
      const controlsArea = document.getElementById("controlsArea");
      const scaleSlider = document.getElementById("scaleSlider");

      uploadInput.addEventListener("change", function (e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (f) {
          fabric.Image.fromURL(f.target.result, function (img) {
            if (!img) return;
            if (userImgNode) canvas.remove(userImgNode);

            // Hitung skala cover
            const coverScale = Math.max(CONFIG.canvasSize / img.width, CONFIG.canvasSize / img.height);

            img.set({
              left: CONFIG.canvasSize / 2,
              top: CONFIG.canvasSize / 2,
              originX: "center",
              originY: "center",
              scaleX: coverScale,
              scaleY: coverScale,
              selectable: false, // Kita matikan seleksi bawaan fabric
              evented: false, // Kita matikan event bawaan fabric
            });

            userImgNode = img;
            canvas.add(userImgNode);

            // Set slider values
            scaleSlider.max = String(Math.max(3, coverScale * 2));
            scaleSlider.value = String(coverScale);

            ensureLayerOrder();
            controlsArea.classList.remove("hidden");
            setTimeout(() => controlsArea.classList.remove("opacity-0"), 100);
          });
        };
        reader.readAsDataURL(file);
      });

      // --- SLIDER ZOOM ---
      scaleSlider.addEventListener("input", function () {
        if (!userImgNode) return;
        const v = parseFloat(this.value);
        userImgNode.set({ scaleX: v, scaleY: v });
        canvas.requestRenderAll();
      });

      // Biar frame samar juga pas mainin slider
      scaleSlider.addEventListener("mousedown", () => {
        if (frameImgNode) {
          frameImgNode.opacity = 0.5;
          canvas.requestRenderAll();
        }
      });
      scaleSlider.addEventListener("touchstart", () => {
        if (frameImgNode) {
          frameImgNode.opacity = 0.5;
          canvas.requestRenderAll();
        }
      });
      scaleSlider.addEventListener("mouseup", () => {
        if (frameImgNode) {
          frameImgNode.opacity = 1;
          canvas.requestRenderAll();
        }
      });
      scaleSlider.addEventListener("touchend", () => {
        if (frameImgNode) {
          frameImgNode.opacity = 1;
          canvas.requestRenderAll();
        }
      });

      // --- DOWNLOAD ---
      document.getElementById("downloadBtn").addEventListener("click", function () {
        // Pastikan normal sebelum download
        if (frameImgNode) frameImgNode.opacity = 1;
        canvas.renderAll();

        const oldVpt = canvas.viewportTransform.slice();
        canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
        canvas.setDimensions({ width: CONFIG.canvasSize, height: CONFIG.canvasSize }, { cssOnly: false });

        const dataURL = canvas.toDataURL({ format: "png", quality: 1, multiplier: 1 });

        canvas.setDimensions({ width: CONFIG.canvasSize, height: CONFIG.canvasSize }, { cssOnly: true });
        canvas.setViewportTransform(oldVpt);
        canvas.requestRenderAll();

        const link = document.createElement("a");
        link.download = "Twibbon-LKMTD-2026.png";
        link.href = dataURL;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      // --- MODAL ---
      const modal = document.getElementById("layanan110Modal");
      document.getElementById("layanan110Btn").onclick = () => modal.classList.remove("hidden");
      document.getElementById("closeModalBtn").onclick = () => modal.classList.add("hidden");
      modal.onclick = (e) => {
        if (e.target === modal) modal.classList.add("hidden");
      };
    </script>
  </body>
</html>
