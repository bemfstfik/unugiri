<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Twibbon Generator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
      .canvas-wrapper {
        max-width: 500px;
        aspect-ratio: 1/1;
        margin: auto;
        border: 2px dashed #900bb7;
        border-radius: 12px;
        overflow: hidden;
        touch-action: none; /* WAJIB */
      }
      canvas {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body class="bg-gray-50 p-6">
    <div class="canvas-wrapper" id="canvasWrapper">
      <canvas id="twibbonCanvas"></canvas>
    </div>

    <input type="file" id="uploadImg" class="mt-4" />
    <button id="downloadBtn">Download</button>

    <script>
      const CONFIG = {
        canvasSize: 1080,
        twibbonUrl: "/assets/images/twibon_LKMTD.png",
      };

      /* ================= CANVAS INIT ================= */
      const canvas = new fabric.Canvas("twibbonCanvas", {
        width: CONFIG.canvasSize,
        height: CONFIG.canvasSize,
        selection: false,
        preserveObjectStacking: true,
      });

      /* ðŸ”¥ KUNCI HP */
      canvas.allowTouchScrolling = false;
      canvas.enableRetinaScaling = false;

      let userImg = null;
      let frameImg = null;

      /* ================= RESPONSIVE ================= */
      function resizeCanvas() {
        const w = document.getElementById("canvasWrapper").clientWidth;
        const zoom = w / CONFIG.canvasSize;
        canvas.setDimensions({ width: w, height: w }, { cssOnly: true });
        canvas.setViewportTransform([zoom, 0, 0, zoom, 0, 0]);
        canvas.requestRenderAll();
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      /* ================= LOAD FRAME ================= */
      fabric.Image.fromURL(
        CONFIG.twibbonUrl,
        (img) => {
          img.set({
            left: 0,
            top: 0,
            scaleX: CONFIG.canvasSize / img.width,
            scaleY: CONFIG.canvasSize / img.height,
            selectable: false,
            evented: false,
            perPixelTargetFind: false,
          });
          frameImg = img;
          canvas.add(frameImg);
        },
        { crossOrigin: "anonymous" }
      );

      /* ================= UPLOAD FOTO ================= */
      document.getElementById("uploadImg").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          fabric.Image.fromURL(ev.target.result, (img) => {
            if (userImg) canvas.remove(userImg);

            const scale = Math.max(CONFIG.canvasSize / img.width, CONFIG.canvasSize / img.height);

            img.set({
              left: CONFIG.canvasSize / 2,
              top: CONFIG.canvasSize / 2,
              originX: "center",
              originY: "center",
              scaleX: scale,
              scaleY: scale,
              selectable: true,
              evented: true,
              hasControls: false,
              hasBorders: false,
              lockUniScaling: true,
              perPixelTargetFind: true,
              hoverCursor: "move",
            });

            userImg = img;
            canvas.add(userImg);
            userImg.moveTo(0);
            frameImg.bringToFront();
            canvas.setActiveObject(userImg);
          });
        };
        reader.readAsDataURL(file);
      });

      /* ================= FIX TOUCH DRAG ================= */

      /* ðŸ”¥ TAP LANGSUNG PEGANG FOTO */
      canvas.on("touch:drag", () => {
        if (userImg) canvas.setActiveObject(userImg);
      });

      /* ðŸ”¥ DOUBLE TAP / GESTURE SUPPORT */
      canvas.on("touch:gesture", (e) => {
        if (!userImg || !e.self.scale) return;
        const s = userImg.scaleX * e.self.scale;
        userImg.scale(s);
        canvas.requestRenderAll();
      });

      /* ================= DOWNLOAD ================= */
      document.getElementById("downloadBtn").onclick = () => {
        const oldVpt = canvas.viewportTransform.slice();

        canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
        canvas.setDimensions({ width: CONFIG.canvasSize, height: CONFIG.canvasSize }, { cssOnly: false });

        const url = canvas.toDataURL({ format: "png", quality: 1 });

        canvas.setDimensions({ width: CONFIG.canvasSize, height: CONFIG.canvasSize }, { cssOnly: true });
        canvas.setViewportTransform(oldVpt);
        resizeCanvas();

        const a = document.createElement("a");
        a.href = url;
        a.download = "Twibbon.png";
        a.click();
      };
    </script>
  </body>
</html>
